--- a/APP_OVERVIEW.md
+++ b/APP_OVERVIEW.md
@@ -1,947 +1,279 @@
-# Demo Raffle v1 - Komplett App√∂versikt
-
-> En omfattande kartl√§ggning av appens struktur, funktioner, komponenter och tekniska implementationer f√∂r utvecklare och utomst√•ende.
-
----
-
-## üìã Inneh√•llsf√∂rteckning
-
-1. [Appens Syfte och Funktion](#appens-syfte-och-funktion)
-2. [Teknisk Stack](#teknisk-stack)
-3. [Projektstruktur](#projektstruktur)
-4. [Databasmodeller](#databasmodeller)
-5. [API Routes](#api-routes)
-6. [Frontend-sidor och Komponenter](#frontend-sidor-och-komponenter)
-7. [Viktiga Funktioner och Flows](#viktiga-funktioner-och-flows)
-8. [Konfiguration](#konfiguration)
-9. [S√§kerhet och Autentisering](#s√§kerhet-och-autentisering)
-10. [Deployment](#deployment)
-
----
-
-## üéØ Appens Syfte och Funktion
-
-**Demo Raffle v1** √§r en webbapplikation f√∂r Twitch streamers som l√•ter tittare anm√§la sig f√∂r att f√• sina musikdemos spelade under streamen. Systemet anv√§nder en **viktad lottning** baserad p√• anv√§ndares Twitch-engagement (subscriptions, bits, donations, gifted subs, etc.).
-
-### Huvudfunktioner
-
-- ‚úÖ **Twitch OAuth Login** - Anv√§ndare m√•ste logga in med Twitch och f√∂lja kanalen
-- ‚úÖ **Viktad Lottning** - Win probability baserad p√• Twitch-engagement
-- ‚úÖ **Realtidsuppdateringar** - Live updates via Twitch EventSub webhooks
-- ‚úÖ **Leaderboard** - Top 20 submissions med live win probability %
-- ‚úÖ **Status-indikator** - Visar om submissions √§r √∂ppna/st√§ngda
-- ‚úÖ **Anti-Whale System** - Caps p√• weights och √•terst√§llning vid vinst
-- ‚úÖ **Carry-over Weight** - Non-winners f√•r bonus-weight till n√§sta stream
-- ‚úÖ **Admin Panel** - Dra vinnare, hantera streams, konfigurera weights
-
----
-
-## üõ† Teknisk Stack
-
-### Frontend & Backend
-- **Next.js 16.0.1** (App Router) - React-ramverk med serverless functions
-- **TypeScript 5** - Typs√§kerhet
-- **Tailwind CSS 4** - Utility-first CSS framework
-- **React 19.2.0** - UI-bibliotek
-
-### Autentisering & Sessions
-- **NextAuth.js v5.0.0-beta.30** - Autentisering med Twitch OAuth
-- **@auth/prisma-adapter 2.11.1** - Databasbaserad session-hantering
-
-### Databas & ORM
-- **PostgreSQL** - Relationsdatabas (Supabase/Railway/Neon/etc.)
-- **Prisma 6.18.0** - ORM f√∂r databashantering
-- **@prisma/client 6.18.0** - Prisma Client
-
-### Externa Integrationer
-- **Twitch API (Helix)** - REST API f√∂r anv√§ndardata
-- **Twitch EventSub** - Webhooks f√∂r real-time events
-- **@twurple/api 7.4.0** - Twitch API-klient
-- **@twurple/auth 7.4.0** - Twitch OAuth-klient
-
-### Validering & Utilities
-- **Zod 4.1.12** - Schema-validering
-- **dotenv 17.2.3** - Environment variables
-
----
-
-## üìÅ Projektstruktur
+# Demo Raffle v1 ‚Äì Current Application Overview
+
+> A factual snapshot of how the Twitch-integrated raffle app is implemented **today**. Every section below is sourced directly from the repository so new contributors can trust it while debugging, extending, or deploying the project.
+
+---
+
+## Contents
+
+1. [Product Scope](#product-scope)
+2. [Technology Stack](#technology-stack)
+3. [Repository Layout](#repository-layout)
+4. [Data Model (Prisma)](#data-model-prisma)
+5. [Authentication & Broadcaster Flow](#authentication--broadcaster-flow)
+6. [Twitch Integration](#twitch-integration)
+7. [API Surface](#api-surface)
+8. [Frontend Surfaces & Components](#frontend-surfaces--components)
+9. [Raffle, Weight & Entry Flows](#raffle-weight--entry-flows)
+10. [Supporting Libraries](#supporting-libraries)
+11. [Configuration & Deployment Notes](#configuration--deployment-notes)
+12. [Additional Docs](#additional-docs)
+
+---
+
+## Product Scope
+
+Demo Raffle v1 lets Twitch viewers log in, prove they follow the broadcaster, and enter a weighted raffle whose odds reflect long-term engagement (subs, bits, donations, gifted subs, carry-over weight). Key behaviors that exist in the codebase:
+
+- **Twitch OAuth + follow gate** ‚Äì Everyone must sign in with Twitch (`next-auth`) and be recorded as a follower in our DB before entering.
+- **Weighted raffle logic** ‚Äì `lib/weight-settings.ts` caps every weight source, while admin endpoints recompute weights in batches to prevent whales.
+- **Live leaderboards & status** ‚Äì `/api/leaderboard` powers both the landing page and the demo portal, with 5s polling on the client.
+- **Carry-over + reset tooling** ‚Äì `/api/twitch/carry-over` and `/api/demo-played` move weight between streams and reset bonus weight after a demo is played.
+- **Broadcaster-only admin** ‚Äì `/app/demo-admin` is a NextAuth-protected panel for the broadcaster to manage entries, edit weight settings, and draw a winner. The legacy `/admin` page remains but no longer grants real access.
+- **EventSub ingestion** ‚Äì `/api/twitch/webhook` verifies Twitch HMAC signatures, deduplicates events (`ProcessedWebhookEvent`), and folds subscription/cheer/follow data back into `User` weights.
+
+---
+
+## Technology Stack
+
+| Layer | Libraries / Services |
+| --- | --- |
+| Runtime | Next.js 16.0.1 (App Router), React 19.2, TypeScript 5 |
+| Auth | NextAuth.js 5 beta + Prisma adapter, Twitch OAuth/OIDC |
+| Database | PostgreSQL (Supabase/Vercel Postgres compatible), Prisma 6.18 |
+| UI | Tailwind CSS 4 (through PostCSS), client/server components |
+| Twitch APIs | Custom Helix fetchers, EventSub webhook handler, `@twurple/*` packages (used by scripts/tests) |
+| Validation / Tooling | Zod (env validation), ESLint 9, dotenv for scripts |
+
+---
+
+## Repository Layout
 
 ```
-demo-raffle-v1/
-‚îú‚îÄ‚îÄ app/                          # Next.js App Router
-‚îÇ   ‚îú‚îÄ‚îÄ api/                      # API Routes (serverless functions)
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin/                # Admin endpoints
-‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/             # Admin session status
-‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entries/          # Entry management (GET/DELETE)
-‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ weight-settings/  # Weight configuration (GET/PUT)
-‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dashboard/        # Combined admin data payload
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/                 # NextAuth routes
-‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [...nextauth]/   # OAuth callback handler
-‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ debug/            # Auth debugging
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ enter/                # Entry submission
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ leaderboard/          # Leaderboard data
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pick-winner/          # Draw winner (admin)
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ twitch/               # Twitch integration
-‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sync/             # Sync user data
-‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ update-weights/   # Recalculate weights
-‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ carry-over/       # Carry over weights
-‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ check-follow/     # Check follow status
-‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ webhook/          # EventSub webhook handler
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user/                 # User endpoints
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ winner/               # Get winner
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ demo-played/          # Mark demo as played
-‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ health/               # Health checks
-‚îÇ   ‚îú‚îÄ‚îÄ components/               # React components
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TwitchLogin.tsx       # Twitch auth button
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DemoSubmissionForm.tsx # Demo link form
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MyStatusCard.tsx      # User weight breakdown
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TopList.tsx           # Leaderboard list
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WeightTable.tsx       # Weight parameters table
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminUserTable.tsx    # Admin entry table
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminWeightsForm.tsx  # Weight settings form
-‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RaffleWheel.tsx        # Animated raffle drawing
-‚îÇ   ‚îú‚îÄ‚îÄ admin/                    # Legacy admin page
-‚îÇ   ‚îú‚îÄ‚îÄ demo-admin/               # Full admin panel
-‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AdminDashboardClient.tsx # Client wrapper fed from server data
-‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx              # Server component gatekeeping access
-‚îÇ   ‚îú‚îÄ‚îÄ demo-portal/              # User dashboard
-‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                  # Landing page
-‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx                # Root layout
-‚îÇ   ‚îî‚îÄ‚îÄ globals.css               # Global styles
-‚îú‚îÄ‚îÄ lib/                          # Shared utilities
-‚îÇ   ‚îú‚îÄ‚îÄ auth.ts                   # NextAuth configuration
-‚îÇ   ‚îú‚îÄ‚îÄ admin-auth.ts             # Session-based admin guard
-‚îÇ   ‚îú‚îÄ‚îÄ prisma.ts                 # Prisma client
-‚îÇ   ‚îú‚îÄ‚îÄ env.ts                    # Environment validation
-‚îÇ   ‚îú‚îÄ‚îÄ twitch-api.ts             # Twitch API helpers
-‚îÇ   ‚îú‚îÄ‚îÄ weight-settings.ts        # Weight calculation
-‚îÇ   ‚îú‚îÄ‚îÄ admin-data.ts             # Shared admin data queries
-‚îÇ   ‚îú‚îÄ‚îÄ draw-lock.ts              # (Legacy) dev-only lock helper
-‚îÇ   ‚îî‚îÄ‚îÄ rate-limit.ts             # (Legacy) dev-only limiter helper
-‚îú‚îÄ‚îÄ prisma/                       # Database schema
-‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma             # Prisma schema
-‚îÇ   ‚îî‚îÄ‚îÄ migrations/                # Database migrations
-‚îú‚îÄ‚îÄ types/                        # TypeScript types
-‚îÇ   ‚îî‚îÄ‚îÄ next-auth.d.ts            # NextAuth type extensions
-‚îú‚îÄ‚îÄ docs/                         # Documentation
-‚îÇ   ‚îú‚îÄ‚îÄ architecture/             # Technical architecture
-‚îÇ   ‚îú‚îÄ‚îÄ deployment/               # Deployment guides
-‚îÇ   ‚îú‚îÄ‚îÄ setup/                    # Setup guides
-‚îÇ   ‚îî‚îÄ‚îÄ reference/                # Reference docs
-‚îú‚îÄ‚îÄ auth.ts                       # NextAuth handler export
-‚îú‚îÄ‚îÄ next.config.ts                # Next.js configuration
-‚îú‚îÄ‚îÄ tsconfig.json                 # TypeScript config
-‚îú‚îÄ‚îÄ package.json                  # Dependencies
-‚îî‚îÄ‚îÄ vercel.json                   # Vercel configuration
+app/
+  api/                 # Route handlers (serverless on Vercel)
+    admin/             # Broadcaster-only CRUD + dashboard data
+    auth/              # NextAuth handler + /debug inspection route
+    demo-played/
+    enter/
+    health/{app,db}/
+    leaderboard/
+    pick-winner/
+    twitch/{sync,check-follow,update-weights,carry-over,webhook}
+    user/submission/
+    winner/
+  admin/               # Legacy password/token-gated UI (not session-aware)
+  components/          # Reusable client components (forms, tables, wheel, etc.)
+  demo-admin/          # Modern admin dashboard (server component + client shell)
+  demo-portal/         # Authenticated user hub
+  page.tsx             # Public landing page + entry form
+lib/
+  admin-auth.ts        # `requireAdminSession()` helper
+  admin-data.ts        # Shared entry listing logic for admin APIs/UI
+  auth.ts              # NextAuth config (see section below)
+  env.ts               # Zod-based env validation
+  prisma.ts            # Prisma client w/ dev hot-reload guard
+  rate-limit.ts        # Dev-only in-memory limiter used by `/api/enter`
+  draw-lock.ts         # Documented no-op (transactions handle locking)
+  twitch-api.ts        # Helix helpers (followers, subscriptions, user info)
+  twitch-oauth.ts      # Token refresh + broadcaster access token retrieval
+  weight-settings.ts   # Cached weight config + calculator
+prisma/
+  schema.prisma        # Models: User, Entry, Account, Session, ProcessedWebhookEvent, WeightSettings
+  migrations/          # Historical migrations
+types/
+  admin.ts             # Entry shape for admin UI/API
+  next-auth.d.ts       # Session/user extensions (isFollower/isBroadcaster)
+docs/                  # Additional setup + deployment guides
+APP_OVERVIEW.md        # This file
+auth.ts                # Re-exports `NextAuth(authOptions)`
 ```
 
 ---
 
-## üìä Databasmodeller
-
-### User
-Lagrar anv√§ndarinfo fr√•n Twitch OAuth och engagement-data.
-
-**F√§lt:**
-- `id` (String, PK) - NextAuth user ID
-- `twitchId` (String, unique) - Twitch user ID
-- `username`, `displayName`, `email`, `image` - Twitch profile data
-- `accessToken`, `refreshToken`, `tokenExpiresAt` - OAuth tokens
-- `isSubscriber`, `isFollower` (Boolean) - Channel status
-- `subMonths`, `totalSubs` (Int) - Subscription data
-- `totalCheerBits`, `totalDonations` (Int) - Engagement metrics
-- `resubCount`, `totalGiftedSubs` (Int) - Additional metrics
-- `currentWeight`, `carryOverWeight`, `totalWeight` (Float) - Weight system
-- `lastUpdated`, `createdAt`, `lastActive` (DateTime) - Timestamps
-
-**Relationer:**
-- `entries` ‚Üí Entry[] (one-to-many)
-- `sessions` ‚Üí Session[] (one-to-many)
-- `accounts` ‚Üí Account[] (one-to-many)
-
-### Entry
-Lottningsanm√§lningar kopplade till anv√§ndare.
-
-**F√§lt:**
-- `id` (Int, PK, auto-increment)
-- `userId` (String?, FK) - Link to User
-- `name` (String) - Display name
-- `email` (String?, unique) - Email address
-- `demoLink` (String?) - Demo URL (SoundCloud, Drive, etc.)
-- `createdAt` (DateTime)
-- `isWinner` (Boolean) - Winner flag
-- `streamId` (String?) - Stream identifier
-
-**Relationer:**
-- `user` ‚Üí User? (many-to-one, optional)
-
-### Account & Session
-NextAuth-relaterade modeller f√∂r OAuth-hantering.
-
-**Account:**
-- Lagrar OAuth provider data (Twitch)
-- Kopplad till User via `userId`
-
-**Session:**
-- Lagrar session tokens
-- Kopplad till User via `userId`
-
-### ProcessedWebhookEvent
-Sp√•rar bearbetade Twitch EventSub-events f√∂r att f√∂rhindra duplicering.
-
-**F√§lt:**
-- `id` (String, PK)
-- `messageId` (String, unique) - Twitch-Eventsub-Message-Id
-- `eventType` (String) - subscription.type
-- `twitchUserId` (String?) - user_id from event
-- `processedAt` (DateTime)
-
-**Indexes:**
-- `messageId` (unique)
-- `processedAt`
-
-### WeightSettings
-Lagrar weight calculation parameters (kan uppdateras via admin panel).
-
-**F√§lt:**
-- `id` (String, PK)
-- `baseWeight` (Float, default: 1.0)
-- `subMonthsMultiplier` (Float, default: 0.1)
-- `subMonthsCap` (Int, default: 10)
-- `resubMultiplier` (Float, default: 0.2)
-- `resubCap` (Int, default: 5)
-- `cheerBitsDivisor` (Float, default: 1000.0)
-- `cheerBitsCap` (Float, default: 5.0)
-- `donationsDivisor` (Float, default: 1000.0)
-- `donationsCap` (Float, default: 5.0)
-- `giftedSubsMultiplier` (Float, default: 0.1)
-- `giftedSubsCap` (Float, default: 5.0)
-- `carryOverMultiplier` (Float, default: 0.5)
-- `createdAt`, `updatedAt` (DateTime)
-
-**Caching:** 1 minut TTL f√∂r prestanda
-
----
-
-## üîå API Routes
-
-### Publika Routes
-
-#### `GET /api/winner`
-H√§mta nuvarande vinnare.
-
-**Response:**
-```json
-{
-  "winner": {
-    "id": 1,
-    "name": "Username",
-    "email": "user@example.com"
-  } | null
-}
-```
-
-#### `GET /api/leaderboard`
-H√§mta top 20 submissions med win probability.
-
-**Response:**
-```json
-{
-  "submissionsOpen": true,
-  "totalEntries": 50,
-  "entries": [
-    {
-      "id": 1,
-      "name": "Username",
-      "weight": 5.2,
-      "probability": 10.4
-    }
-  ]
-}
-```
-
-#### `GET /api/health/app`
-Health check f√∂r applikationen.
-
-#### `GET /api/health/db`
-Health check f√∂r databasanslutning.
-
----
-
-### Autentiserade Routes (Twitch Login kr√§vs)
-
-#### `POST /api/enter`
-Anm√§l sig till raffle (kr√§ver Twitch login + follow).
-
-**Request:**
-```json
-{
-  "name": "Display Name (optional)",
-  "demoLink": "https://soundcloud.com/..." (optional)
-}
-```
-
-**Validering:**
-- Kr√§ver Twitch login
-- Kr√§ver channel follow
-- Rate limiting: 5 submissions/user/hour, 10 submissions/IP/hour
-- Demo link m√•ste vara fr√•n SoundCloud, Google Drive, eller Dropbox
-- En aktiv submission per anv√§ndare
-
-**Response:**
-```json
-{
-  "success": true,
-  "id": 1
-}
-```
-
-#### `POST /api/twitch/sync`
-Synka anv√§ndares Twitch-data (subscriptions, bits, donations, etc.).
-
-**Response:**
-```json
-{
-  "success": true,
-  "user": { ... }
-}
-```
-
-#### `POST /api/twitch/check-follow`
-Kontrollera om anv√§ndaren f√∂ljer kanalen.
-
-**Response:**
-```json
-{
-  "isFollower": true
-}
-```
-
-#### `GET /api/user/submission`
-H√§mta anv√§ndarens nuvarande submission.
-
-**Response:**
-```json
-{
-  "entry": {
-    "id": 1,
-    "name": "Username",
-    "demoLink": "...",
-    "isWinner": false
-  } | null
-}
-```
-
----
-
-### Admin Routes (NextAuth broadcastersession kr√§vs)
-
-Alla moderna admin-endpoints anropar `requireAdminSession`, vilket betyder att du m√•ste vara inloggad via NextAuth med den verifierade broadcaster-anv√§ndaren. √Ñldre `ADMIN_TOKEN` anv√§nds endast av den legacy-sidan `/admin` och p√•verkar inte backendvalideringen.
-
-#### `GET /api/admin/dashboard`
-Returnerar en sammanst√§lld payload (entries + weight settings) som anv√§nds f√∂r att initialt hydrera adminpanelen p√• serversidan.
-
-#### `GET /api/admin/entries`
-Lista samtliga √∂ppna entries med st√∂d f√∂r `search`, `sortBy` (`name`/`weight`) och `sortOrder` (`asc`/`desc`).
-
-#### `DELETE /api/admin/entries/[id]`
-Tar bort en specifik entry om den fortfarande √§r √∂ppen (non-winner).
-
-#### `GET /api/admin/weight-settings`
-Returnerar aktuella weight-parametrar fr√•n `WeightSettings`-tabellen.
-
-#### `PUT /api/admin/weight-settings`
-Uppdaterar weight-parametrar (helt eller delvis) och returnerar den nya konfigurationen.
-
-#### `GET /api/admin/auth`
-Returnerar en enkel `{ authenticated: boolean, user: { ... } }` payload baserat p√• aktuell NextAuth-session (POST/DELETE √§r avst√§ngda i produktion).
-
-#### `POST /api/pick-winner`
-Drar en vinnare via en transaktion som b√•de markerar `Entry.isWinner` och nollst√§ller vinnarens bonuspo√§ng; endast broadcaster-sessioner accepteras.
-
-#### `POST /api/demo-played`
-Tar en `userId` och nollst√§ller den anv√§ndarens bits/gifts samt triggar vikt-rekalkylering efter att en demo spelats upp.
-
-#### `POST /api/twitch/update-weights`
-Bulk-uppdaterar `currentWeight`/`totalWeight` (i batchar) baserat p√• nuvarande engagement-data; kan filtreras p√• `streamId`.
-
-#### `POST /api/twitch/carry-over`
-Ber√§knar och sparar `carryOverWeight` f√∂r alla non-winners (med m√∂jlighet att nollst√§lla via `resetWeights` flaggan) och kan begr√§nsas till ett visst `streamId`.
-
----
-
-### Webhooks
-
-#### `POST /api/twitch/webhook`
-Twitch EventSub webhook handler.
-
-**Validering:**
-- HMAC-SHA256 signaturverifiering
-- Timestamp-validering (max 10 minuter gammal)
-- Duplicate event detection
-- Replay attack protection
-
-**Event Types:**
-- `channel.subscribe` - Subscription events
-- `channel.subscription.gift` - Gifted subscriptions
-- `channel.cheer` - Bits cheered
-- `channel.follow` - Follow events
-
-**Response:**
-- `200 OK` f√∂r verification challenges
-- `200 OK` f√∂r bearbetade events
-- `400 Bad Request` f√∂r ogiltiga requests
-
----
-
-## üé® Frontend-sidor och Komponenter
-
-### Sidor
-
-#### `/` (Landing Page)
-**Fil:** `app/page.tsx`
-
-**Funktion:**
-- Visar raffle entry form (kr√§ver Twitch login + follow)
-- Visar top 20 leaderboard med live updates (5s polling)
-- Visar status banner (submissions open/closed)
-- Visar vinnare n√§r raffle √§r klar
-
-**Komponenter:**
-- `TwitchLogin` - Twitch auth button
-- `TopList` - Leaderboard list
-
-**States:**
-- Loading states f√∂r winner/leaderboard
-- Error handling f√∂r API calls
-- Follow status check
-
----
-
-#### `/demo-portal` (User Dashboard)
-**Fil:** `app/demo-portal/page.tsx`
-
-**Funktion:**
-- User dashboard med demo submission
-- Visar user's weight breakdown
-- Visar top 20 leaderboard
-- Visar weight parameters table
-- Status banner f√∂r submissions
-
-**Komponenter:**
-- `TwitchLogin` - Twitch auth button
-- `DemoSubmissionForm` - Demo link form
-- `MyStatusCard` - User weight breakdown
-- `TopList` - Leaderboard list
-- `WeightTable` - Weight parameters table
-
-**Features:**
-- Auto-refresh leaderboard (5s polling)
-- Real-time weight updates
-- Demo link validation
-
----
-
-#### `/demo-admin` (Admin Panel)
-**Fil:** `app/demo-admin/page.tsx`
-
-**Funktion:**
-- Full admin panel med tabs
-- Entry management (search, sort, remove)
-- Weight settings configuration
-- Draw winner med animation
-
-**Tabs:**
-1. **Users** - Alla entries med search/sort/remove
-2. **Weights** - Redigerbar weight settings form
-3. **Raffle** - Draw winner button + Top 20 f√∂r stream
-
-**Komponenter:**
-- `AdminUserTable` - Entry table med search/sort
-- `AdminWeightsForm` - Weight settings form
-- `RaffleWheel` - Animerad raffle drawing
-- `TopList` - Leaderboard list
-
-**Features:**
-- Server-side gate via NextAuth (endast broadcaster n√•r sidan)
-- H√§mtar initial data via serverkomponent och `/api/admin/dashboard`
-- Klientpollning f√∂r att h√•lla entries/leaderboard/weights f√§rska
-- Animated winner selection med `RaffleWheel`
-
----
-
-#### `/admin` (Legacy Admin)
-**Fil:** `app/admin/page.tsx`
-
-**Funktion:**
-- Enkel admin-sida f√∂r att dra vinnare (legacy)
-- Anv√§nds f√∂r bak√•tkompatibilitet
-
----
-
-### Komponenter
-
-#### `TwitchLogin.tsx`
-**Fil:** `app/components/TwitchLogin.tsx`
-
-**Funktion:**
-- Twitch authentication button
-- Visar user info n√§r inloggad
-- Logout funktion
-
-**Props:** Inga
-
-**Features:**
-- NextAuth session integration
-- User profile display
-- Logout handling
-
----
-
-#### `DemoSubmissionForm.tsx`
-**Fil:** `app/components/DemoSubmissionForm.tsx`
-
-**Funktion:**
-- Form f√∂r att skicka in demo link
-- Validerar demo URL (SoundCloud, Drive, Dropbox)
-- Visar existing submission om finns
-
-**Props:** Inga
-
-**Features:**
-- URL validation
-- Allowed domains check
-- Existing submission display
-
----
-
-#### `MyStatusCard.tsx`
-**Fil:** `app/components/MyStatusCard.tsx`
-
-**Funktion:**
-- Visar user's total weight och breakdown
-- Visar weight sources (subs, bits, donations, etc.)
-
-**Props:** Inga
-
-**Features:**
-- Weight calculation display
-- Breakdown by source
-- Real-time updates
-
----
-
-#### `TopList.tsx`
-**Fil:** `app/components/TopList.tsx`
-
-**Funktion:**
-- Leaderboard lista (top 20)
-- Visar namn, weight, och win probability
-
-**Props:**
-- `entries` - LeaderboardEntry[]
-- `totalEntries` - number
-- `submissionsOpen` - boolean
-
-**Features:**
-- Scrollable list
-- Win probability display
-- Real-time updates
-
----
-
-#### `WeightTable.tsx`
-**Fil:** `app/components/WeightTable.tsx`
-
-**Funktion:**
-- Tabell √∂ver weight parameters
-- Visar alla weight settings
-
-**Props:**
-- `settings` - WeightSettings
-
-**Features:**
-- Read-only display
-- Parameter explanations
-
----
-
-#### `AdminUserTable.tsx`
-**Fil:** `app/components/AdminUserTable.tsx`
-
-**Funktion:**
-- Tabell med alla entries
-- Search och sort funktioner
-- Remove entry funktion
-
-**Props:**
-- `entries` - Entry[]
-- `onRemove` - (id: number) => void
-
-**Features:**
-- Search by name/email
-- Sort by name/createdAt/weight
-- Remove confirmation
-
----
-
-#### `AdminWeightsForm.tsx`
-**Fil:** `app/components/AdminWeightsForm.tsx`
-
-**Funktion:**
-- Redigerbar form f√∂r weight settings
-- Uppdaterar weight parameters
-
-**Props:** Inga
-
-**Features:**
-- Form validation
-- Real-time updates
-- Success/error feedback
-
----
-
-#### `RaffleWheel.tsx`
-**Fil:** `app/components/RaffleWheel.tsx`
-
-**Funktion:**
-- Animerad raffle drawing
-- Scroll-effekt med winner highlight
-
-**Props:**
-- `entries` - Entry[]
-- `winnerId` - number
-- `seed` - number (f√∂r deterministisk animation)
-
-**Features:**
-- Smooth scroll animation
-- Winner highlight
-- Deterministic animation (seed-based)
-
----
-
-#### `AdminDashboardClient.tsx`
-**Fil:** `app/demo-admin/AdminDashboardClient.tsx`
-
-**Funktion:**
-- Hydrerar den moderna adminpanelen med server-f√∂rberedd data (entries + weight settings)
-- Sk√∂ter polling mot `/api/admin/dashboard` och `/api/leaderboard`
-- Exponerar callbacks som triggar refresh efter t.ex. winner-dragning
-
-**Props:**
-- `initialEntries` ‚Äì Entrypayload fr√•n serverkomponenten
-- `initialSettings` ‚Äì Senaste weight settings
-
-**Features:**
-- Konsumerar NextAuth-sessionen indirekt via serverkomponenten
-- Visar tabs (Users/Weights/Raffle)
-- Triggar `RaffleWheel` och uppdaterar UI efter √•tg√§rder
-
----
-
-## üîÑ Viktiga Funktioner och Flows
-
-### Twitch OAuth Flow
-
-1. **User klickar "Sign in with Twitch"**
-   - Redirect till Twitch OAuth
-   - Scopes: `user:read:email`
-
-2. **Twitch Callback**
-   - NextAuth tar emot callback
-   - `signIn` callback k√∂rs
-
-3. **signIn Callback** (`lib/auth.ts`)
-   - H√§mtar anv√§ndardata fr√•n Twitch API
-   - Kontrollerar att anv√§ndaren f√∂ljer kanalen (**M√ÖSTE**)
-   - Blockerar login om inte f√∂ljare
-   - Uppdaterar/l√§gger till anv√§ndare i databas
-   - Returnerar `true` f√∂r lyckad login
-
-4. **Session Creation**
-   - NextAuth skapar session
-   - Session lagras i databas (Prisma Adapter)
-
----
-
-### Weight Calculation Flow
-
-1. **Weight Settings** (`lib/weight-settings.ts`)
-   - H√§mtar weight settings fr√•n databas (cached 1 min)
-   - Default values om inga settings finns
-
-2. **Weight Calculation** (`lib/twitch-api.ts`)
-   - Baserat p√• user's engagement data:
-     - **Base Weight**: 1.0
-     - **Sub Months**: `min(subMonths * multiplier, cap)`
-     - **Resubs**: `min(resubCount * multiplier, cap)`
-     - **Cheer Bits**: `min(bits / divisor, cap)`
-     - **Donations**: `min(donations / divisor, cap)`
-     - **Gifted Subs**: `min(giftedSubs * multiplier, cap)`
-     - **Carry-over**: `carryOverWeight * multiplier`
-
-3. **Total Weight**
-   - `totalWeight = baseWeight + sum(all sources)`
-   - Lagras i `User.totalWeight`
-
-4. **Win Probability**
-   - `probability = (user.totalWeight / sum(all weights)) * 100`
-
----
-
-### Raffle Drawing Flow
-
-1. **Admin klickar "Draw Winner"**
-   - `POST /api/pick-winner` anropas
-   - Endast en inloggad NextAuth-session f√∂r broadcastern sl√§pps igenom
-
-2. **Transaktionsskydd**
-   - Prisma-transaktionen l√§ser + uppdaterar entryn i ett steg
-   - Fungerar som global l√•sning √§ven i serverless-milj√∂er
-
-3. **Entry Selection**
-   - H√§mtar alla non-winner entries med user weights
-   - Weighted random selection:
-     ```typescript
-     const random = Math.random() * totalWeight
-     let sum = 0
-     for (const entry of entries) {
-       sum += entry.user.totalWeight
-       if (random <= sum) return entry
-     }
-     ```
-
-4. **Winner Update**
-   - Transaction: Uppdaterar `Entry.isWinner = true`
-   - Om user finns: √Öterst√§ller `User.currentWeight = 1.0`
-   - Returnerar winner data med seed f√∂r animation
-
-5. **Client Animation**
-   - `RaffleWheel` komponenten anv√§nder seed f√∂r deterministisk animation
-   - Scroll-effekt med winner highlight
-
----
-
-### Twitch EventSub Webhook Flow
-
-1. **Webhook Registration**
-   - Admin registrerar webhooks i Twitch Developer Console
-   - Webhook URL: `https://your-domain.com/api/twitch/webhook`
-   - Events: `channel.subscribe`, `channel.subscription.gift`, `channel.cheer`, `channel.follow`
-
-2. **Webhook Verification** (`app/api/twitch/webhook/route.ts`)
-   - Twitch skickar verification challenge
-   - Appen returnerar `challenge` token
-
-3. **Event Processing**
-   - HMAC-SHA256 signaturverifiering
-   - Timestamp-validering (max 10 minuter gammal)
-   - Duplicate event detection (via `ProcessedWebhookEvent`)
-   - Replay attack protection
-
-4. **Data Update**
-   - Uppdaterar user's engagement data i databas
-   - Triggar weight recalculation om n√∂dv√§ndigt
-
----
-
-### Carry-over Weight Flow
-
-1. **Stream Ends**
-   - Admin markerar demo som spelad (`POST /api/demo-played`)
-
-2. **Carry-over Process** (`POST /api/twitch/carry-over`)
-   - H√§mtar alla non-winners f√∂r stream
-   - Ber√§knar carry-over weight:
-     ```typescript
-     carryOverWeight = (totalWeight - baseWeight) * carryOverMultiplier
-     ```
-   - Uppdaterar `User.carryOverWeight`
-
-3. **Next Stream**
-   - N√§r weights uppdateras, inkluderas carry-over weight
-   - Non-winners f√•r bonus-weight till n√§sta stream
-
----
-
-## ‚öôÔ∏è Konfiguration
-
-### Milj√∂variabler
-
-**Databas:**
-```env
-DATABASE_URL="postgresql://user:password@host:port/database"
-DIRECT_URL="postgresql://user:password@host:port/database"
-```
-- `DATABASE_URL`: Pooled connection (f√∂r queries)
-- `DIRECT_URL`: Direct connection (f√∂r migrations)
-- F√∂r Supabase: Se `docs/setup/SUPABASE_SETUP.md`
-
-**Twitch OAuth:**
-```env
-TWITCH_CLIENT_ID="your_twitch_client_id"
-TWITCH_CLIENT_SECRET="your_twitch_client_secret"
-TWITCH_BROADCASTER_ID="your_broadcaster_user_id"
-```
-
-**Twitch Webhooks:**
-```env
-TWITCH_WEBHOOK_SECRET="your_webhook_secret"
-```
-
-**NextAuth:**
-```env
-NEXTAUTH_URL="http://localhost:3000"  # Production: https://your-domain.com
-NEXTAUTH_SECRET="your_nextauth_secret"  # Generate: openssl rand -base64 32
-```
-
-**Admin (endast legacy-/admin-sidan):**
-```env
-ADMIN_TOKEN="your-secret-admin-token"
-```
-`ADMIN_TOKEN` anv√§nds bara av den √§ldre `/admin`-vyn som fortfarande har ett enkelt UI-l√•s; moderna admin-API:er f√∂rlitar sig p√• NextAuth-sessionen.
-
-### Next.js Configuration
-
-**`next.config.ts`:**
-```typescript
-import type { NextConfig } from "next";
-
-const nextConfig: NextConfig = {
-  /* config options here */
-};
-
-export default nextConfig;
-```
-
-**`vercel.json`:**
-```json
-{
-  "version": 2
-}
-```
-
-### Prisma Configuration
-
-**`prisma/schema.prisma`:**
-- Datasource: PostgreSQL
-- Connection pooling support (Supabase)
-- Direct URL f√∂r migrations
-
----
-
-## üîê S√§kerhet och Autentisering
-
-### Twitch OAuth Security
-
-- **User Token**: H√§mtas via NextAuth f√∂r varje tittare och anv√§nds f√∂r individuella datah√§mtningssteg.
-- **Broadcaster Token**: Kommer fr√•n broadcasterns eget NextAuth-konto (lagras i `Account` via Prisma) och auto-refreshas innan den anv√§nds f√∂r scopes som `channel:read:subscriptions`, `moderator:read:followers` och `bits:read`.
-- **Follow Check**: Obligatorisk channel follow f√∂r login
-- **Token Refresh**: Hanteras centraliserat i `lib/twitch-oauth.ts` + NextAuth `jwt` callback
-
-### Admin Authentication
-
-- **Broadcaster-first**: `lib/admin-auth.ts` anv√§nder `auth()` och kr√§ver att `session.user.isBroadcaster` √§r `true`.
-- **NextAuth-sessioner**: Alla admin-endpoints k√∂rs i Vercels serverless-milj√∂ och litar p√• samma HTTP-only sessioncookies som resten av appen.
-- **Legacy token**: `ADMIN_TOKEN` existerar enbart f√∂r den √§ldre `/admin`-sidan; backend-validering baseras inte l√§ngre p√• denna token.
-
-### Webhook Security
-
-- **HMAC-SHA256**: Signaturverifiering
-- **Timestamp Validation**: Max 10 minuter gammal
-- **Duplicate Detection**: `ProcessedWebhookEvent` tabell
-- **Replay Protection**: Message ID tracking
-
-### API Security
-
-- **Idempotenta endpoints**: Serverless funktionsfl√∂den √§r utformade s√• att upprepade anrop inte skadar (rate-limit helpern √§r endast aktiv i lokal utveckling).
-- **Input Validation**: Zod schemas
-- **SQL Injection Protection**: Prisma parameterized queries
-- **CORS**: Next.js default (same-origin)
-
----
-
-## üöÄ Deployment
-
-### Vercel (Rekommenderat)
-
-1. **GitHub Integration**
-   - Push till GitHub
-   - Vercel auto-detekterar Next.js
-   - Auto-deploy fr√•n `main` branch
-
-2. **Environment Variables**
-   - L√§gg till alla milj√∂variabler i Vercel Dashboard
-   - Se `docs/deployment/DEPLOYMENT.md` f√∂r lista
-
-3. **Database Setup**
-   - Supabase (rekommenderat): Se `docs/setup/SUPABASE_SETUP.md`
-   - Railway, Neon, etc.: Se `docs/deployment/DATABASE_RECOMMENDATIONS.md`
-
-4. **Twitch Webhooks**
-   - Registrera webhooks i Twitch Developer Console
-   - Webhook URL: `https://your-domain.com/api/twitch/webhook`
-   - Se `docs/setup/TWITCH_SETUP.md`
-
-5. **Custom Domain**
-   - L√§gg till custom domain i Vercel
-   - Konfigurera DNS
-   - Uppdatera `NEXTAUTH_URL`
-   - Se `docs/deployment/CUSTOM_DOMAIN_SETUP.md`
-
-### Build Process
-
-1. **Install Dependencies**
-   ```bash
-   npm install
-   ```
-
-2. **Prisma Generate**
-   ```bash
-   npx prisma generate
-   ```
-   (K√∂rs automatiskt via `postinstall` script)
-
-3. **Database Migrations**
-   ```bash
-   npx prisma migrate deploy
-   ```
-   (K√∂rs automatiskt p√• Vercel)
-
-4. **Build**
-   ```bash
-   npm run build
-   ```
-
-### Health Checks
-
-- `GET /api/health/app` - App health
-- `GET /api/health/db` - Database health
-
----
-
-## üìö Ytterligare Dokumentation
-
-- **Teknisk Arkitektur**: `docs/architecture/ARCHITECTURE.md`
-- **Version-specifik Dokumentation**: `docs/reference/DOCUMENTATION_VERSIONS.md`
-- **Deployment Guide**: `docs/deployment/DEPLOYMENT.md`
-- **Supabase Setup**: `docs/setup/SUPABASE_SETUP.md`
-- **Twitch Setup**: `docs/setup/TWITCH_SETUP.md`
-
----
-
-## üéØ Sammanfattning
-
-**Demo Raffle v1** √§r en komplett webbapplikation f√∂r Twitch streamers som kombinerar:
-
-- **Modern Tech Stack**: Next.js 16, React 19, TypeScript, Prisma
-- **Twitch Integration**: OAuth, EventSub webhooks, Helix API
-- **Viktad Lottning**: Engagement-baserad win probability
-- **Real-time Updates**: Live leaderboard och weight updates
-- **Admin Tools**: Entry management, weight configuration, winner drawing
-- **S√§kerhet**: HMAC webhooks, rate limiting, input validation
-- **Scalability**: Serverless functions, connection pooling, caching
-
-Appen √§r designad f√∂r produktion med fokus p√• s√§kerhet, prestanda och anv√§ndarupplevelse.
-
+## Data Model (Prisma)
+
+- **User** ‚Äì Core Twitch identity (id, twitchId, username, displayName, avatar, OAuth mirror fields). Tracks engagement metrics (`totalCheerBits`, `totalDonations`, `totalGiftedSubs`, `resubCount`), subscription state (`isSubscriber`, `subMonths`, `totalSubs`), follow flag, calculated weights (`currentWeight`, `carryOverWeight`, `totalWeight`), and timestamps (`lastUpdated`, `lastActive`). Relations to `Entry`, `Account`, and `Session`.
+- **Entry** ‚Äì Raffle entry tied to a user (optional because historical entries might predate required login). Stores `demoLink`, email, `isWinner`, optional `streamId`.
+- **Account/Session** ‚Äì NextAuth tables generated by Prisma adapter; Account rows mirror Twitch tokens.
+- **ProcessedWebhookEvent** ‚Äì Deduplication log (unique `messageId`, `eventType`, `twitchUserId`, `processedAt` indexes).
+- **WeightSettings** ‚Äì Single-row config containing every multiplier/cap the calculator uses. IDs are `cuid()` and `getWeightSettings()` keeps a 60s in-memory cache to cut DB load.
+
+---
+
+## Authentication & Broadcaster Flow
+
+All logic lives in `lib/auth.ts` and is exported through `auth.ts` for route handlers and server components.
+
+### Provider configuration
+- Twitch provider uses **OIDC scopes** (`openid user:read:email`) plus `state` and `pkce` checks, aligning with Auth.js v5 guidance.
+- Prisma adapter is used with JWT sessions (`strategy: 'jwt'`) and `trustHost: true` for App Router deployments.
+
+### `updateUserTwitchData(userId, accessToken)`
+- Fetches the viewer‚Äôs profile via `getUserInfo` (user access token).
+- Attempts to fetch a broadcaster token using `getBroadcasterAccessToken()`. If that throws (e.g., broadcaster hasn‚Äôt signed in yet), we log a warning **only in development** and continue with `null`.
+- Only when a broadcaster token exists do we call `checkUserFollowsChannel()` and `getUserSubscription()`. Each call is wrapped in its own `try/catch`; failures log and fall back to safe defaults (`isFollower = false`, `subscription = non-subscriber`).
+- Upserts the user record with fresh Twitch profile data, latest follow/subscriber booleans, subscription months, and timestamps. Any error propagates to the caller (the sign-in callback handles the throwable).
+
+### Sign-in callback
+- Runs only for Twitch provider logins with an access token.
+- Computes `isBroadcasterAccount` by comparing `account.providerAccountId` to `env.TWITCH_BROADCASTER_ID`.
+- Calls `updateUserTwitchData` inside a `try/catch`. Errors never block login; in development we log `console.error('updateUserTwitchData failed‚Ä¶')`.
+- **Follow gate for viewers**: Non-broadcaster accounts trigger a DB lookup (`prisma.user.findUnique({ select: { isFollower } })`). If the viewer still isn‚Äôt marked as a follower after the sync, sign-in returns `false` and NextAuth aborts the login.
+- Broadcaster accounts are always allowed through (we already need their session online to refresh tokens and use the admin panel).
+
+### JWT callback
+- Stores Twitch tokens (`access_token`, `refresh_token`, `expires_at`) on `token.twitch`.
+- Checks a 5-minute buffer (`TOKEN_REFRESH_BUFFER_MS`) and refreshes via `refreshTwitchAccessToken()` when needed.
+- Writes refreshed tokens back to the Prisma `Account` row when `providerAccountId` is known.
+
+### Session callback
+- Ensures `session.user.id` is always populated (reads from JWT `sub`).
+- Looks up the user to expose `session.isFollower`.
+- Marks broadcaster sessions by inspecting the JWT twitch state (`providerAccountId === env.TWITCH_BROADCASTER_ID`) and mirrors that to both `session.isBroadcaster` and `session.user.isBroadcaster`.
+
+### Admin guard
+- `lib/admin-auth.ts` wraps `auth()` and returns the session only if `session.user.isBroadcaster` is true. Every admin API route uses this helper, so any request without an authenticated broadcaster session receives `401 Unauthorized`.
+
+---
+
+## Twitch Integration
+
+### Helix helpers (`lib/twitch-api.ts`)
+- `checkUserFollowsChannel` and `getUserSubscription` fetch the broadcaster token lazily. A 30‚ÄØs in-memory cache prevents repeated DB queries for the same invocation.
+- Each helper logs and returns safe defaults instead of throwing. Consumers expect booleans and fallback subscription objects, so failure never blocks login/sync flows.
+
+### Broadcaster tokens (`lib/twitch-oauth.ts`)
+- `getBroadcasterAccessToken` reads the Twitch `Account` row for `TWITCH_BROADCASTER_ID`.
+- If `refresh_token` is missing, it throws a clear error prompting the broadcaster to sign in (caught upstream).
+- Uses `TOKEN_REFRESH_BUFFER_SECONDS` to refresh via the standard Twitch OAuth endpoint and persists new tokens back to Prisma.
+
+### User sync (`app/api/twitch/sync`)
+- Requires an authenticated viewer session.
+- Enforces a per-user 60s cooldown (`USER_SYNC_COOLDOWN_MS`).
+- Loads the viewer‚Äôs Twitch `Account` access token from Prisma, fetches their follow/subscriber state via the broadcaster token, and recalculates weights with `calculateUserWeight`. The response exposes the sanitized `User` shape for UI components like `TwitchLogin` and `MyStatusCard`.
+
+### EventSub webhook (`app/api/twitch/webhook/route.ts`)
+- Validates Twitch HMAC signatures, rejects stale timestamps (>10‚ÄØmin), and handles verification challenges (returns plaintext `challenge`).
+- Uses `ProcessedWebhookEvent` to dedupe events inside a transaction before touching user data.
+- Processes: `channel.subscribe`, `channel.subscription.message`, `channel.subscription.gift`, `channel.cheer`, `channel.follow`. Each handler updates the relevant counters on `User` and calls the shared weight recalculator.
+- Even on processing errors, the handler responds with 2XX to avoid webhook revocation (errors are logged).
+
+---
+
+## API Surface
+
+### Public (no session required)
+- `GET /api/leaderboard` ‚Äì Returns `{ submissionsOpen, totalEntries, entries[] }`. It derives `submissionsOpen` from `Entry.isWinner` and includes probability-per-entry for the top 20 weights.
+- `GET /api/winner` ‚Äì Returns the first winner or `null`.
+- `GET /api/health/app` ‚Äì Process uptime + version.
+- `GET /api/health/db` ‚Äì Runs `SELECT 1` via Prisma to confirm DB connectivity.
+
+### Authenticated viewer routes
+- `POST /api/enter` ‚Äì Validates session, follow flag, rate limits by IP (`checkRateLimit('ip:‚Ä¶', 10/hr)`) and user (5/hr), enforces unique active entries, verifies demo links (SoundCloud / Drive / Dropbox) and creates a Prisma `Entry` with optional demo link + email.
+- `POST /api/twitch/check-follow` ‚Äì Returns `{ isFollower }` from the stored `User` record.
+- `POST /api/twitch/sync` ‚Äì Described above; returns `{ success, user, skipped? }`.
+- `GET /api/user/submission` ‚Äì Returns the viewer‚Äôs current non-winning entry if one exists.
+
+### Broadcaster-only admin routes (all call `requireAdminSession`)
+- `GET /api/admin/dashboard` ‚Äì Bundles entries (`getAdminEntries`) and `WeightSettings` for initial render.
+- `GET /api/admin/entries` ‚Äì Accepts `search`, `sortBy=name|weight`, `sortOrder=asc|desc` query params before returning formatted entries for the table.
+- `DELETE /api/admin/entries/[id]` ‚Äì Deletes an entry (validates numeric `id`).
+- `GET /api/admin/weight-settings` / `PUT /api/admin/weight-settings` ‚Äì Fetch and update `WeightSettings`. PUT accepts partial payloads, coercing numbers and validating everything before saving.
+- `GET /api/admin/auth` ‚Äì Simple `{ authenticated, user }` response for client polling (POST/DELETE return 405).
+- `POST /api/pick-winner` ‚Äì Runs a weighted random draw inside a 5‚ÄØs Prisma transaction, marks the winner, resets some engagement counters, recalculates weight for the winning user, and returns metadata for the `RaffleWheel`.
+- `POST /api/demo-played` ‚Äì Resets bits/gifted subs for a specific user and recalculates their weight.
+- `POST /api/twitch/update-weights` ‚Äì Optionally filters by `streamId`, batches users (25 per chunk), recomputes weights via `calculateUserWeight`, and writes current/total weight inside a transaction.
+- `POST /api/twitch/carry-over` ‚Äì Accepts `{ streamId?, resetWeights? }`, finds non-winners, sets their `carryOverWeight` to either 0 or `user.totalWeight * 0.5`, normalizes `currentWeight`, and clears the winner‚Äôs carry-over if needed.
+
+### Legacy routes
+- `/app/admin` still exists for reference and still asks for `ADMIN_TOKEN`, but every modern API ignores that header and trusts NextAuth broadcaster sessions instead. Treat it as a deprecated UI.
+- `POST /api/twitch/webhook` ‚Äì Discussed above.
+- `app/api/auth/debug` ‚Äì Diagnostic endpoint that tries to import `env` and `auth()` separately to surface runtime issues.
+
+---
+
+## Frontend Surfaces & Components
+
+### Landing page (`app/page.tsx`)
+- Client component wrapped in a `SessionProvider`.
+- Fetches `/api/winner` once, `/api/leaderboard` every 5‚ÄØs, and `/api/twitch/check-follow` after login.
+- Shows `TwitchLogin`, entry form (name only‚Äîdemo links handled in the portal), live status banner, and a scrollable Top 20 leaderboard.
+
+### Demo portal (`app/demo-portal/page.tsx`)
+- Authenticated ‚Äúviewer dashboard‚Äù with the same status banner, `TwitchLogin`, `DemoSubmissionForm` (calls `/api/enter` + `/api/user/submission`), `MyStatusCard` (weights from `/api/twitch/sync`) and a read-only `WeightTable`. Uses 5‚ÄØs polling for leaderboard and displays weight settings fetched from `/api/admin/weight-settings` (read-only).
+
+### Admin dashboard (`app/demo-admin`)
+- Server component gate uses `auth()`; non-broadcaster sessions see an ‚ÄúAdmin Access Required‚Äù screen.
+- `AdminDashboardClient` mounts with `initialEntries`/`initialSettings`, polls `/api/admin/dashboard` + `/api/leaderboard` every 10‚ÄØs, and exposes three tabs:
+  - **Users** ‚Äì `AdminUserTable` with search/sort, delete buttons (calls `/api/admin/entries/[id]`).
+  - **Weights** ‚Äì `AdminWeightsForm` that PUTs new settings to `/api/admin/weight-settings` and notifies the parent via `onSettingsChange`.
+  - **Raffle** ‚Äì `RaffleWheel` that POSTs `/api/pick-winner` and a Top 20 view for stream overlay reference.
+
+### Shared components
+- `TwitchLogin` ‚Äì Sign in/out CTA plus a purple stats card that pings `/api/twitch/sync` every 2‚ÄØminutes (ignores 429) and shows follower/subscriber state + weight breakdown.
+- `DemoSubmissionForm` ‚Äì Keeps local state, calls `/api/enter`, and renders either a submission form or the viewer‚Äôs existing entry (via `/api/user/submission`).
+- `MyStatusCard` ‚Äì Mirrors backend weight math client-side for a quick breakdown; polls `/api/twitch/sync`.
+- `TopList` ‚Äì Presentational leaderboard used by multiple pages.
+- `WeightTable` ‚Äì Read-only view of current multipliers/caps.
+- `AdminUserTable`, `AdminWeightsForm`, `RaffleWheel` ‚Äì Admin-specific UI described above.
+
+---
+
+## Raffle, Weight & Entry Flows
+
+1. **Viewer login** ‚Äì NextAuth handles Twitch OAuth. During `signIn`, `updateUserTwitchData` populates the `User` row and ensures viewers are marked as followers. Broadcaster accounts bypass the follow gate so they can maintain admin access even if Twitch follower data is temporarily unavailable.
+2. **Entry creation** ‚Äì `/api/enter` enforces login, follow state, one active entry per user, IP/user rate limits via `checkRateLimit`, and domain checks for demo links. Entries always connect to the `User` via `user: { connect: { id } }`.
+3. **Weight calculation** ‚Äì `calculateUserWeight` pulls cached settings (refresh every minute) and stacks contributions from sub months, resubs, bits, donations, gifted subs, and carry-over. Admin maintenance endpoints call this helper whenever engagement data changes.
+4. **Raffle draw** ‚Äì `/api/pick-winner` fetches all non-winning entries, performs a weighted random draw, wraps the mutation in a Prisma transaction (re-reading the specific entry for consistency), updates the winner, resets certain stats, and recalculates the winner‚Äôs weight afterwards. The response includes `spinList`, `totalWeight`, and `seed` so the client animation can replay deterministically.
+5. **Carry-over** ‚Äì `/api/twitch/carry-over` loops over batches of non-winners and applies 50% carry-over weight (unless `resetWeights` is true). Winners have their `carryOverWeight` zeroed.
+6. **Demo played** ‚Äì `/api/demo-played` is a manual reset that zeroes bits/gifted subs once a viewer‚Äôs track was featured live.
+
+---
+
+## Supporting Libraries
+
+- `lib/rate-limit.ts` ‚Äì Simple in-memory counter keyed by string. It is only reliable in development (documented at the top) but still helps catch obvious abuse locally. Production code must remain idempotent.
+- `lib/draw-lock.ts` ‚Äì Explicitly returns `true` and documents that concurrency protection relies on database transactions now.
+- `lib/env.ts` ‚Äì Validates all required environment variables with Zod up front (`TWITCH_CLIENT_ID`, `TWITCH_CLIENT_SECRET`, `TWITCH_BROADCASTER_ID`, `TWITCH_WEBHOOK_SECRET`, `NEXTAUTH_URL`, `NEXTAUTH_SECRET`, `DATABASE_URL`, `DIRECT_URL`, `ADMIN_TOKEN`). Falls back to `DIRECT_URL = DATABASE_URL` (with a dev warning) if unset.
+- `lib/prisma.ts` ‚Äì Creates a singleton Prisma client, logs errors/warnings in development, and attempts an eager connection to fail fast when `DATABASE_URL` is wrong.
+- `lib/admin-data.ts` ‚Äì Centralizes the admin entry query and filtering (search/sort) so both routes and client components share the same formatting logic.
+
+---
+
+## Configuration & Deployment Notes
+
+Required environment variables (validated in `lib/env.ts`):
+
+| Variable | Description |
+| --- | --- |
+| `TWITCH_CLIENT_ID`, `TWITCH_CLIENT_SECRET` | Twitch App credentials |
+| `TWITCH_BROADCASTER_ID` | Numeric Twitch user ID of the channel that owns the raffle/admin panel |
+| `TWITCH_WEBHOOK_SECRET` | Shared secret for EventSub signature verification |
+| `NEXTAUTH_URL`, `NEXTAUTH_SECRET` | Standard NextAuth config (URL must match deployment host) |
+| `DATABASE_URL` | Pooled Postgres connection string (PgBouncer/Supabase) |
+| `DIRECT_URL` | Direct Postgres connection for migrations (defaults to `DATABASE_URL` if omitted) |
+| `ADMIN_TOKEN` | Only referenced by the legacy `/admin` page; modern APIs ignore it |
+
+Deployment expectations:
+
+- Vercel is the default target (`runtime = 'nodejs'`, `dynamic = 'force-dynamic'` on every route). No Edge runtimes are used.
+- `npm run build` triggers Next.js build; `postinstall` runs `prisma generate`; `prisma migrate deploy` should run as part of deployment (documented in `/docs/deployment`).
+- Health checks are exposed at `/api/health/app` and `/api/health/db`.
+- EventSub must be configured in the Twitch Developer Console to point at `/api/twitch/webhook`.
+
+---
+
+## Additional Docs
+
+- `docs/architecture/ARCHITECTURE.md` ‚Äì Deep dive into the original system design.
+- `docs/setup/SUPABASE_SETUP.md` / `docs/setup/TWITCH_SETUP.md` ‚Äì Environment provisioning guides.
+- `docs/deployment/*.md` ‚Äì CI/CD and Vercel deployment walkthroughs.
+- `docs/reference/DOCUMENTATION_VERSIONS.md` ‚Äì Tracks historical fixes.
+
+---
+
+## Summary
+
+The current Demo Raffle v1 codebase pairs a modern Next.js 16 App Router frontend with strict Auth.js (NextAuth) enforcement, Prisma-backed persistence, and Twitch Helix/EventSub integrations. Broadcaster sessions are the single source of truth for admin access, and new error-handling in `lib/auth.ts` ensures viewer logins never fail just because broadcaster tokens are missing. All API routes, components, and helper libraries documented above match the real implementation so contributors can confidently extend the raffle, weight, or admin functionality without second-guessing the architecture.
+